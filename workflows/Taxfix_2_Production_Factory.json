{
    "name": "Taxfix_2_Production_Factory",
    "nodes": [
        {
            "parameters": {},
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                250,
                300
            ],
            "id": "manual-trigger"
        },
        {
            "parameters": {
                "operation": "getAll",
                "tableId": "content_queue",
                "limit": 1,
                "filters": {
                    "conditions": [
                        {
                            "key": "status",
                            "value": "PENDING_GENERATION",
                            "operator": "eq"
                        }
                    ]
                }
            },
            "name": "Get Pending Job",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                450,
                300
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "supabase_api_creds",
                    "name": "Supabase API"
                }
            },
            "id": "get-job"
        },
        {
            "parameters": {
                "resource": "chat",
                "model": "gpt-4o",
                "jsonOutput": true,
                "messages": {
                    "values": [
                        {
                            "content": "You are a tax expert for Taxfix. Generate a TikTok video script for the topic: \"{{ $json.topic }}\".\n\nReturn strict JSON with these keys:\n- script_structure: { \"hook\": \"...\", \"body\": \"...\", \"cta\": \"...\" }\n- social_metrics: { \"caption\": \"...\", \"hashtags\": [\"...\"] }"
                        }
                    ]
                }
            },
            "name": "Generate Script",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [
                650,
                300
            ],
            "id": "generate-script",
            "credentials": {
                "openAiApi": {
                    "id": "openai_account",
                    "name": "OpenAI account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Parse OpenAI JSON and merge with original ID\nconst aiContent = $json.message.content;\nlet parsed = {};\ntry {\n  parsed = JSON.parse(aiContent);\n} catch(e) {\n  parsed = { error: \"Failed to parse AI JSON\", raw: aiContent };\n}\n\n// Pass through original ID and other keys from the *previous* node (Get Pending Job)\n// We need to access the parent data. Since n8n logic can be tricky, we'll explicitly pass ID from input if preserved, or we rely on the flow.\n// Wait, OpenAI node might replace top-level JSON. \n// To be safe, we will rely on the fact that we can access the 'Get Pending Job' node data directly in the Update node, OR we re-map it here.\n\nreturn {\n  ...parsed,\n  id: $('Get Pending Job').item.json.id, // Explicitly grab ID from the trigger source to be safe\n  topic: $('Get Pending Job').item.json.topic,\n  source_url: $('Get Pending Job').item.json.source_url\n};"
            },
            "name": "Parse AI Response",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                750,
                300
            ],
            "id": "parse-ai-response"
        },
        {
            "parameters": {
                "resource": "embeddings",
                "model": "text-embedding-3-small",
                "text": "={{ $json.script_structure.body }}",
                "jsonOutput": true
            },
            "name": "Create Embeddings",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [
                850,
                300
            ],
            "id": "create-embeddings",
            "credentials": {
                "openAiApi": {
                    "id": "openai_account",
                    "name": "OpenAI account"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "select * from match_tax_laws( '{{ $json.embedding }}', 0.5, 3 )",
                "jsonOutput": true
            },
            "name": "Vector Search",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                950,
                300
            ],
            "id": "vector-search",
            "credentials": {
                "supabaseApi": {
                    "id": "supabase_api_creds",
                    "name": "Supabase API"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Merge Retrieved Docs for Context\nconst docs = $items.map(i => i.json.content).join('\\n---\\n');\n// We need to pass the ORIGINAL script data to the next node too. \n// In n8n, this is best done by accessing the 'Parse AI Response' node directly in the next OpenAI node.\nreturn { docs };"
            },
            "name": "Merge Context",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                1050,
                300
            ],
            "id": "merge-context"
        },
        {
            "parameters": {
                "resource": "chat",
                "model": "gpt-4o",
                "jsonOutput": true,
                "messages": {
                    "values": [
                        {
                            "content": "You are a Compliance Officer. Check the following video script for accuracy against the provided Tax Laws.\n\nSCRIPT:\n{{ $('Parse AI Response').item.json.script_structure.body }}\n\nTAX LAWS:\n{{ $json.docs }}\n\nReturn strict JSON:\n- compliance_score: (0.0 to 1.0)\n- validations: { \"checks\": [\"Checked against law X...\"], \"rag_notes\": \"Found law X matching...\" }"
                        }
                    ]
                }
            },
            "name": "Check Compliance",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [
                1150,
                300
            ],
            "id": "check-compliance",
            "credentials": {
                "openAiApi": {
                    "id": "openai_account",
                    "name": "OpenAI account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Prepare Final Update Payload\n// Merge everything: ID, Script (from Parse AI), Compliance (from Check Compliance)\nconst scriptData = $('Parse AI Response').item.json;\nconst complianceData = JSON.parse($json.message.content);\n\nreturn {\n  ...scriptData,\n  ...complianceData,\n  status: \"PENDING_REVIEW\"\n};"
            },
            "name": "Prepare Update",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                1250,
                300
            ],
            "id": "prepare-update"
        },
        {
            "parameters": {
                "operation": "update",
                "tableId": "content_queue",
                "options": {
                    "ignoreExtraFields": true
                },
                "autoMapInputData": true,
                "inputsToIgnore": "id,created_at,updated_at",
                "filters": {
                    "conditions": [
                        {
                            "key": "id",
                            "value": "={{ $json.id }}",
                            "operator": "eq"
                        }
                    ]
                }
            },
            "name": "Update DB",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                1050,
                300
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "supabase_api_creds",
                    "name": "Supabase API"
                }
            },
            "id": "update-db"
        },
        {
            "parameters": {
                "content": "## Mock Factory (Phase 2)\n\nThis workflow simulates the full pipeline:\n\n1. **Get Job**: Fetches pending job (Supabase API).\n2. **Mock GenAI**: Returns static script/json.\n3. **Mock RAG**: Returns 0.92 score + validations.\n4. **Update DB**: Saves to content_queue (Supabase API).\n\n**Run this to populate Dashboard Tabs 2 & 3!**",
                "height": 300,
                "width": 600
            },
            "name": "Phase 2 Info",
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                400,
                100
            ],
            "id": "info-note"
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Get Pending Job",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Pending Job": {
            "main": [
                [
                    {
                        "node": "Generate Script",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Script": {
            "main": [
                [
                    {
                        "node": "Parse AI Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse AI Response": {
            "main": [
                [
                    {
                        "node": "Create Embeddings",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Embeddings": {
            "main": [
                [
                    {
                        "node": "Vector Search",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Vector Search": {
            "main": [
                [
                    {
                        "node": "Merge Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Context": {
            "main": [
                [
                    {
                        "node": "Check Compliance",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Compliance": {
            "main": [
                [
                    {
                        "node": "Prepare Update",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Update": {
            "main": [
                [
                    {
                        "node": "Update DB",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}